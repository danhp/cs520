#!/bin/bash
function run {
  # # call golite with command and filename
  ./src/golite $2 $1  1> /dev/null;
  # # Only write if successful
  if [ "$?" -eq 0 ]; then
    ./src/golite $2 $1 1> "outputs/$pref.$3";
  fi
}

if [ "$#" -eq 0 ]; then
  make -C src/
else
  # assumes the script was called like one of the following:
  #   a) ./run file [-pptype | -dumpsymtab] ---> golite flag file
  #   b) ./run file                         ---> golite pretty

  # find filename
  for last; do true; done

  code=true

  base=$(basename $last})
  pref=${base%.*};
  rm outputs/$pref.* > /dev/null 2>&1;

  while [[ $# > 0 ]]
  do
    p="$1"
    case $p in
      -h|--help)
        echo "./run [-h|-v|-dumpsymtab|-pptype] filename"
        exit
        ;;
      -v|--version)
        echo "version 4"
        exit
        ;;
      -dumpsymtab)
        code="false"
        run $last "dumpsymtab" "symtab"
        ;;
      -pptype)
        code="false"
        run  $last "pptype" "pptype.go"
        ;;
      *)    #unknown option - assume it's filename
        if [ "$code" = true  ] ; then
          run $p "code" "cpp"
        fi
        ;;
    esac
    shift
  done
fi
