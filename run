#!/bin/bash
if [ "$#" -eq 0 ]; then
  make -C src/
else
  # assumes the script was called like one of the following:
  #   a) ./run file [-pptype | -dumpsymtab] ---> golite flag file
  #   b) ./run file                         ---> golite pretty

  while [[ $# > 0 ]]
  do
    p="$1"
    case $p in
      -h|--help)
        echo "./run [-h|-v|-dumpsymtab|-pptype] filename"
        exit
        ;;
      -v|--version)
        echo "version 4"
        exit
        ;;
      -dumpsymtab)
        cmd="dumpsymtab"
        output_file="symtab"
        shift
        file=$1
        ;;
      -pptype)
        cmd="pptype"
        output_file="pptype"
        shift
        file=$1
        ;;
      *)    #unknown option - assume it's filename
        file=$p
        output_file="cpp"
        cmd="code"
        ;;
    esac
    shift
  done

  base=$(basename $file})
  pref=${base%.*};

  rm outputs/$pref.* > /dev/null 2>&1;

  # # call golite with command and filename
  ./src/golite $cmd $file  1> /dev/null;
  # # Only write if successful
  if [ "$?" -eq 0 ]; then
    ./src/golite $cmd $file 1> "outputs/$pref.$output_file";
    if [ "$#" -eq 3 ]; then
      cmd=${3:1}
      output_file=$([ "$cmd" = "dumpsymtab" ] && echo "symtab" || echo "$cmd".go )
      ./src/golite $cmd $file 1> outputs/$pref.$output_file;
    fi
  fi
fi
